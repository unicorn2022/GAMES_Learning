[TOC]

# 第4课	变换2：三维变换

## 4.0	有关旋转的补充

**旋转矩阵的逆 == 旋转矩阵的转置** ==> **旋转矩阵为正交矩阵**
$$
R_{\theta}=
\left(
\begin{matrix}
\cos\theta & -\sin\theta \\ 
\sin\theta & \cos\theta
\end{matrix}
\right) \\

R_{-\theta}=
\left(
\begin{matrix}
\cos\theta & \sin\theta \\ 
-\sin\theta & \cos\theta
\end{matrix}
\right)
=R_{\theta}^T \\

R_{-\theta}=R_\theta^{-1}
$$

正交矩阵：$R^T=R^{-1}$

## 4.1	3D Transformations

### 4.4.1	齐次坐标

1.   3维点：$(x,y,z,1)^T$
2.   3维点的补充形式：$(x,y,z,w)^T$与$(\frac{x}{w},\frac{y}{w},\frac{z}{w},1)^T$等价
3.   3维向量：$(x,y,z,0)^T$

### 4.4.2	仿射变换

> **Affine Transform**：

1. 变换的顺序：先**线性变换**，后加**平移**量

<img src="AssetMarkdown/image-20220812113815122.png" alt="image-20220812113815122" style="zoom:80%;" />

#### 4.4.2.1	缩放

<img src="AssetMarkdown/image-20220812113919856.png" alt="image-20220812113919856" style="zoom:80%;" />

#### 4.4.2.2	平移

<img src="AssetMarkdown/image-20220812113927686.png" alt="image-20220812113927686" style="zoom:80%;" />

#### 4.4.2.3	旋转

##### 4.4.2.3.1	绕坐标轴旋转

1. 绕X轴：X不变，YZ旋转

   <img src="AssetMarkdown/image-20220812114205936.png" alt="image-20220812114205936" style="zoom:80%;" />

2. 绕Y轴：Y不变，ZX旋转

   <img src="AssetMarkdown/image-20220812114238231.png" alt="image-20220812114238231" style="zoom:80%;" />

3. 绕Z轴：Z不变，XY旋转

   <img src="AssetMarkdown/image-20220812114220868.png" alt="image-20220812114220868" style="zoom:80%;" />

##### 4.4.2.3.2	绕任意过原点的轴旋转

> 有两种形式：欧拉角、四元数
>
> 1. 四元数：多应用于旋转的插值操作

1. 绕任意轴旋转：分解为**欧拉角**

   1.   将任意轴方向的旋转，分解为绕X、Y、Z轴的旋转：$R_{x,y,z}(\alpha,\beta,\gamma)$
   2.   $\alpha,\beta,\gamma$也被称为欧拉角

   <img src="AssetMarkdown/image-20230226070451531.png" alt="image-20230226070451531" style="zoom: 80%;" />

2. **Rodrigues’ Rotation Formula 罗德里格旋转公式**

   1.   向量**v**绕过原点的轴**n**旋转**$\alpha$**角
   1.   向量**I**为向量**v**方向的单位向量

   <img src="AssetMarkdown/image-20230226070549341.png" alt="image-20230226070549341" style="zoom:80%;" />

> 推导思路：
>
> 1. **v**与**n**垂直时，$\vec{v'}=\cos\alpha*\vec{v}+\sin\alpha*(\vec{n}×\vec{I})$
>
> 2. **v**与**n**不垂直时，将**v**分解为 垂直于**n**的向量**v~⊥~** 和平行于**n**的向量**v~∥~**
>
>    1.   $\vec{v_∥'}=\vec{v_∥}=|\vec{v}|*cos<\vec{v},\vec{n}>=\vec{v}·\vec{n}·\vec{n}$
>    2.   $\vec{v_⊥}=\vec{v}-\vec{v_∥}=\vec{v}-\vec{v}·\vec{n}·\vec{n}$
>    3.   $\vec{v_⊥'}=\cos\alpha*\vec{v_⊥}+\sin\alpha*(\vec{n}×\vec{v_⊥})$
>    4.   综上可得：$\vec{v'}=\vec{v_∥'}+\vec{v_⊥'}=\cos\alpha*\vec{v}+(1-\cos\alpha)*\vec{v}·\vec{n}·\vec{n}+\sin\alpha*(\vec{n}×\vec{v})$
>
> 3. 矩阵形式：$\vec{v'}=\cos\alpha*\vec{v}+(1-\cos\alpha)*\vec{v}·\vec{n}·\vec{n}+\sin\alpha*(\vec{n}×\vec{v})$$
>
>    ​						$=[\cos\alpha*\vec{I}+(1-\cos\alpha)*\vec{n}·\vec{n}^T+\sin\alpha*(\vec{n}×\vec{I})]·\vec{v}$

##### 4.4.2.3.2	绕过任意点的任意轴旋转

绕过任意轴**n**旋转**$\alpha$**角

1.   先将轴平移至过原点
2.   然后旋转
3.   最后平移回去

## 4.2	Model & View Transformation

### 4.2.1	什么是视图变换

1.   与照相类比：**MVP**变换

|             照相             |                对应变换                |
| :--------------------------: | :------------------------------------: |
|   找一个好的地方、人物排列   |   模型变换 **model** transformation    |
|   找一个好的角度放置摄像机   |    视图变换 **view** transformation    |
| 拍照，三维空间投影到二维平面 | 投影变换 **projection** transformation |

### 4.2.2	定义Camera

1.   位置**Position**：$\vec{e}$
2.   往哪看**Look-at/gaze direction**：$\vec{g}$
3.   向上方向**Up direction**：$\vec{t}$

<img src="AssetMarkdown/image-20220812123220752.png" alt="image-20220812123220752" style="zoom:80%;" />

### 4.2.3	关键点：相机与物体的相对位置决定看到的图像

1. 只要**摄像机**与**物体**的相对位置一样，所看到的图形就是一样的

   ![image-20220812123524813](AssetMarkdown/image-20220812123524813.png)

2. 将摄像机永远放在一个标准的位置

   1.   **Position**：原点
   2.   **Up direction**：Y轴
   3.   **Look-at direction**：-Z轴

3. 当相机变换时，将物体随着相机变换

### 4.2.4	将相机移动到标准位置

1. 方法

   1.   将$\vec{e}$平移到**原点**
   2.   旋转 $\vec{g}$ 到**-Z**的方向
   3.   旋转 $\vec{t}$ 到**Y**的方向
   4.   旋转 $\vec{g}×\vec{t}$ 到**X**方向

2. 矩阵表示：设$M_{view}=R_{view}T_{view}$

   1. 将$\vec{e}$平移到原点

      <img src="AssetMarkdown/image-20220812164249448.png" alt="image-20220812164249448" style="zoom:80%;" />

   2. 旋转 $\vec{g}$ 到**-Z**、 $\vec{t}$ 到**Y**、$\vec{g}×\vec{t}$ 到**X**：考虑逆矩阵

      <img src="AssetMarkdown/image-20220812164531901.png" alt="image-20220812164531901" style="zoom:80%;" />

### 4.2.5	总结

1.   将物体与相机一起旋转：**Model Transformation ==> $M_{model}$**
2.   将相机变换到标准位置：**View Transformation ==> $M_{view}$**
     1.   Position：原点
     2.   Up direction：Y轴
     3.   Look-at direction：-Z轴

## 4.3	Projection Transformation

1.   正交投影 **Orthographic Projection**：不存在近大远小
2.   透视投影 **Perspective Projection**：存在近大远小，平行线不再平行

<img src="AssetMarkdown/image-20220812165450522.png" alt="image-20220812165450522" style="zoom:80%;" />

### 4.3.1	正交投影

> **Orthographic Projection**：
>
> 1. 思想：直接扔掉物体的Z坐标，然后将其移动到[-1,1]的便准范围内

1. 实际做法：将一个立方体$[l, r]×[b, t]×[f, n]$映射到标准立方体$[-1, 1]^3$上

   1.   首先，通过**平移**操作，将立方体的中心移到原点
   2.   然后，通过**缩放**操作，将立方体缩放为标准立方体
   3.   立方体的定义：X轴$[l,r]$；Y轴$[b,t]$；Z轴$[f,n]$
   4.   变换之后，物体一定会有拉伸 

   <img src="AssetMarkdown/image-20220812170410007.png" alt="image-20220812170410007" style="zoom:80%;" />

2. 变换矩阵：先平移到原点，再将$x,y,z$缩放到$2$

   $$
   M_{ortho}=
   \left(
   \begin{matrix}
   \frac{2}{r-l} & 0 			  & 0   		  & 0 \\
   0 			  & \frac{2}{t-b} & 0   		  & 0 \\
   0 			  & 0 			  & \frac{2}{n-f} & 0 \\
   0 			  & 0 			  & 0   		  & 1 \\
   \end{matrix}
   \right)
   
   \left(
   \begin{matrix}
   1 & 0 & 0 & -\frac{r+l}{2} \\
   0 & 1 & 0 & -\frac{t+b}{2} \\
   0 & 0 & 1 & -\frac{n+f}{2} \\
   0 & 0 & 0 & 1 \\
   \end{matrix}
   \right)
   
   =
   \left(
   \begin{matrix}
   \frac{2}{r-l} & 0 			  & 0   		  & -\frac{r+l}{r-l} \\
   0 			  & \frac{2}{t-b} & 0   		  & -\frac{t+b}{t-b} \\
   0 			  & 0 			  & \frac{2}{n-f} & -\frac{n+f}{n-f} \\
   0 			  & 0 			  & 0   		  & 1 \\
   \end{matrix}
   \right)
   $$

### 4.3.2	透视投影

> **Perspective Projection**
>
> 1. 基础知识：$(x,y,z,1)$与$(kx,ky,kz,k)$表示同一个点，因此$(xz,yz,z^2,z)$表示的也是这个点
> 2. 思想：将透视投影转化为正交投影$M_{persp->ortho}$，然后再进行正交投影变换$M_{ortho}$

#### 4.3.2.1	如何进行透视投影

<img src="AssetMarkdown/image-20220812171751431.png" alt="image-20220812171751431" style="zoom:80%;" />

1.   首先，定义从相机点向外的两个平面**n、f**，**f**平面要比**n**平面大
2.   此时就相当于**f**平面上的点全部投影到**n**平面上
3.   透视投影的做法
     1.   先将**Frustum**挤成**Cuboid**($n \rightarrow n，f \rightarrow f'$)，满足如下三个定义：$M_{persp->ortho}$
          1.   近平面$n$永远不变
          2.   远平面$f$的Z值永远不变
          3.   远平面$f$的中心点$(0,0,f)$永远不变
     2.   再进行一次正交投影：$M_{ortho}$

#### 4.3.2.2	计算矩阵$M_{persp->ortho}$

1. 思路：找到变换后的点$(x',y',z')$与原来的点$(x,y,z)$的对应关系

2. 从YZ平面上看，挤压前后存在相似三角形，从而可得到$y'=\frac{n}{z}*y$

   1.   同理，$x'=\frac{n}{z}*x$

   <img src="AssetMarkdown/image-20220812172142284.png" alt="image-20220812172142284" style="zoom:80%;" />

3. 齐次坐标表示

   <img src="AssetMarkdown/image-20220812172516140.png" alt="image-20220812172516140" style="zoom:80%;" />

4. 矩阵表示

   |  由3得   | <img src="AssetMarkdown/image-20220812172528972.png" alt="image-20220812172528972" style="zoom:80%;" /> |
   | :------: | :----------------------------------------------------------: |
   | **因此** | <img src="AssetMarkdown/image-20220812172545755.png" alt="image-20220812172545755" style="zoom:80%;" /> |

5. 对于矩阵的第三行(对于Z值)，有以下性质

   |                   在近平面上的点，坐标不变                   |
   | :----------------------------------------------------------: |
   | <img src="AssetMarkdown/image-20220812173013770.png" alt="image-20220812173013770" style="zoom:80%;" /> |
   | <img src="AssetMarkdown/image-20220812173047212.png" alt="image-20220812173047212" style="zoom:80%;" /> |
   | <img src="AssetMarkdown/image-20220812173249005.png" alt="image-20220812173249005" style="zoom:80%;" /> |

   |            在远平面上的中心点$(0,0,f)$，坐标不变             |
   | :----------------------------------------------------------: |
   | <img src="AssetMarkdown/image-20220812173205858.png" alt="image-20220812173205858" style="zoom:80%;" /> |

   |                 根据两个等式，可以解出$A,B$                  |
   | :----------------------------------------------------------: |
   | <img src="AssetMarkdown/image-20220812173341348.png" alt="image-20220812173341348" style="zoom:80%;" /> |

6. 综上
   $$
   M_{persp \rightarrow ortho}=
   \left(
   \begin{matrix}
   n & 0 & 0   & 0 \\
   0 & n & 0   & 0 \\
   0 & 0 & n+f & -nf \\
   0 & 0 & 1   & 0 \\
   \end{matrix}
   \right)
   $$

7. 最后，再进行正交投影：$M_{persp}=M_{ortho}M_{persp->ortho}$

$$
M_{persp}=
\left(
\begin{matrix}
\frac{2}{r-l} & 0 			  & 0   		  & -\frac{r+l}{r-l} \\
0 			  & \frac{2}{t-b} & 0   		  & -\frac{t+b}{t-b} \\
0 			  & 0 			  & \frac{2}{n-f} & -\frac{n+f}{n-f} \\
0 			  & 0 			  & 0   		  & 1 \\
\end{matrix}
\right)

\left(
\begin{matrix}
n & 0 & 0   & 0 \\
0 & n & 0   & 0 \\
0 & 0 & n+f & -nf \\
0 & 0 & 1   & 0 \\
\end{matrix}
\right)

=

\left(
\begin{matrix}
\frac{2n}{r-l}	& 0 			 & -\frac{r+l}{r-l} & 0 \\
0 				& \frac{2n}{t-b} & -\frac{t+b}{t-b} & 0  \\
0 				& 0				 & \frac{n+f}{n-f}	& -\frac{2nf}{n-f} \\
0 				& 0				 & 1				& 0 \\
\end{matrix}
\right)
$$

#### 4.3.3.3	对于不在近/远平面上的点

$$
\left(
\begin{matrix}
n & 0 & 0   & 0 \\
0 & n & 0   & 0 \\
0 & 0 & n+f & -nf \\
0 & 0 & 1   & 0 \\
\end{matrix}
\right)

\left(
\begin{matrix}
x \\
y \\
z \\
1 \\
\end{matrix}
\right)
=

\left(
\begin{matrix}
nx \\
ny \\
(n+f)z-nf \\
z \\
\end{matrix}
\right)

==>
\left(
\begin{matrix}
\frac{n}{z}x \\
\frac{n}{z}y \\
(n+f)-\frac{nf}{z} \\
1 \\
\end{matrix}
\right)
$$

1.   近平面上的点$(z=n)$
     1.   $z'=(n+f)-\frac{nf}{n}=n$
     2.   $z'=z$
2.   远平面上的点$(z=f)$
     1.   $z'=(n+f)-\frac{nf}{f}=f$
     2.   $z'=z$
3.   不在近/远平面上的点$(f<z<n)$
     1.   $z'=(n+f)-\frac{nf}{z}$
          1.   设$n=1,f=-1,z=0.5$，则$z'=2$
          2.   设$n=1,f=-1,z=-0.5$，则$z'=-2$
     2.   可得：若$z<0$，则$z'$更靠近**远平面$f$**；若$z>0$，则$z'$更靠近**近平面$n$**

#### 4.3.3.4	定义视锥

> 定义一个视锥，需要
>
> 1.   宽高比：**Aspect ratio**
> 2.   垂直的可视角度：**Vertical Field of View**

<img src="AssetMarkdown/image-20220813112938428.png" alt="image-20220813112938428" style="zoom:80%;" />

1. **Aspect ratio 纵横比**：$\frac{width}{height}$

2. **field-of-view(fovY)视野**：从摄像机所在位置出发，连接屏幕宽的两个中点，两条线所夹的角度

3. 从**fovY**和**Aspect**推出**l, r, b, t**

   <img src="AssetMarkdown/image-20220813113243520.png" alt="image-20220813113243520" style="zoom:80%;" />